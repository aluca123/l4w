/* l4w 2017-08-25 00:27 */

"use strict";function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}var _get=function t(e,i,n){null===e&&(e=Function.prototype);var o=Object.getOwnPropertyDescriptor(e,i);if(void 0===o){var r=Object.getPrototypeOf(e);return null===r?void 0:t(r,i,n)}if("value"in o)return o.value;var a=o.get;if(void 0!==a)return a.call(n)},_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},_createClass=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}(),BlockDirection=function t(){_classCallCheck(this,t)};BlockDirection.UP=Math.pow(2,0),BlockDirection.DOWN=Math.pow(2,1),BlockDirection.LEFT=Math.pow(2,2),BlockDirection.RIGHT=Math.pow(2,3);var RenderConfiguration=function t(){_classCallCheck(this,t),this.showGrid=!1,this.showEditorGrid=!1,this.showFPS=!1,this.showCellNumbers=!1,this.showFocus=!1,this.enableSelection=!1,this.showBlocks=!1,this.enableAntialiasing=!0,this.fps=0},Constant;!function(t){t.DOUBLE_PI=2*Math.PI;var e=function t(){_classCallCheck(this,t)};e.YELLOW="yellow",e.RED="red",e.WHITE="white",e.GREY="grey",e.BLACK="black",t.Color=e;var i=function t(){_classCallCheck(this,t)};i.GET="GET",i.POST="POST",t.RequestType=i;!function(t){t[t.LOW=0]="LOW",t[t.MID=1]="MID",t[t.TOP=2]="TOP",t[t.EVENTS=3]="EVENTS"}(t.MapLayer||(t.MapLayer={}));!function(t){t[t.APPLY=0]="APPLY",t[t.ERASE=1]="ERASE"}(t.EditMode||(t.EditMode={}));!function(t){t[t.NONE=0]="NONE",t[t.BLOCKS=1]="BLOCKS"}(t.TileEditMode||(t.TileEditMode={}))}(Constant||(Constant={}));var Resource;!function(t){function e(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"l4w";m.has(e)?t(m.get(e)):n(d+"properties/"+e+".properties",function(n){var o=i(this.responseText);m.set(e,o),t(o)})}function i(t){for(var e=new Map,i=t.split("\n"),n=0;n<i.length;n++){var o=i[n].trim();if(""!==o&&0!==o.indexOf("#")){var r=o.split("="),a=+r[1];isNaN(a)?e.has(r[1])?e.set(r[0],e.get(r[1])):console.error("Error parsing properties file at line "+n+": "+a):e.set(r[0],a)}}return e}function n(t,e){r(Constant.RequestType.GET,null,t,e)}function o(t,e,i){r(Constant.RequestType.POST,e,t,i)}function r(t,e,i,n){var o=new XMLHttpRequest;o.onload=n,o.onerror=function(t){console.error("Error while getting "+i),console.log(t),n(null)},o.ontimeout=function(){console.error("Timeout while getting "+i),n(null)},o.open(t,i,!0);try{Utils.isEmpty(e)||t!==Constant.RequestType.POST?o.send():o.send(e)}catch(t){"NetworkError"===t.name?console.error("If you are working locally on Chrome, please launch it with option --allow-file-access-from-files"):(console.error(t),console.trace()),n(null)}}function a(t,e,i){Utils.isEmpty(t)&&(console.error("Trying to load empty file!"),console.trace());var o=u(t,e);switch(e){case 0:case 1:case 2:case 3:var r=$(document.createElement("img"));r.attr("src",o),r.load(function(){y.set(e+g+t,r[0]),i(r)});break;case 4:case 5:case 6:n(o,function(t){i(this.responseText)});break;default:console.error("Unexpected resource type"),console.trace(),i(null)}}function s(t,e){var i=y.get(e+g+t);return Utils.isEmpty(i)&&a(t,e,function(i){y.set(e+g+t,i[0])}),i}function l(t){return s(v,t)}function c(t,e,i,n){o(h(t,i),e,function(t){200===this.status?n(!0):(console.error(this.status+" - "+this.response),n(!1))})}function u(t,e){var i;switch(e){case 0:case 1:case 2:case 3:switch(i=p,e){case 0:i+="charset/";break;case 1:i+="faceset/";break;case 2:i+="skin/";break;case 3:i+="tile/";break;default:console.error("Unexpected resource type"),console.trace()}break;case 4:case 5:case 6:switch(i=d,e){case 4:i+="map/";break;case 5:i+="save/";break;case 6:i+="tileset/";break;default:console.error("Unexpected resource type"),console.trace()}break;default:console.error("Unexpected resource type"),console.trace()}return i+t}function h(t,e){var i=f;switch(e){case 4:i+="map/";break;case 5:i+="save/";break;case 6:i+="tileset/";break;default:console.error("Unexpected resource type"),console.trace()}return i+t}var d=base_path+"data/",p=base_path+"assets/",f=base_path+"edit/",g="@",v="404.png",y=new Map,m=new Map;t.loadProperties=e,t.load=a,t.loadImageFromCache=s,t.loadDefaultImage=l,t.save=c}(Resource||(Resource={}));var GridTypeEnum;!function(t){t[t.game=0]="game",t[t.mapper=1]="mapper",t[t.tilePicker=2]="tilePicker"}(GridTypeEnum||(GridTypeEnum={}));var AbstractGrid=function(){function t(e,i,n){_classCallCheck(this,t),this.canvas=e,this.currentTranslation={x:0,y:0},this.gridType=n,function(t){Resource.loadProperties(function(e){t.deferredInit(e),t.updateSizingDerivates(),t.refresh(),i(t)})}(this)}return _createClass(t,[{key:"deferredInit",value:function(t){this.cellH=t.get("cellHeight"),this.cellW=t.get("cellWidth"),this.rows=t.get(GridTypeEnum[this.gridType]+"Rows"),this.columns=t.get(GridTypeEnum[this.gridType]+"Columns")}},{key:"updateSizingDerivates",value:function(){this.baseH=this.cellH*this.rows,this.baseW=this.cellW*this.columns,this.halfRows=Math.floor(this.rows/2),this.halfColumns=Math.floor(this.columns/2)}},{key:"refresh",value:function(){this.canvas.width=this.baseW*this.scaleX,this.canvas.height=this.baseH*this.scaleY}},{key:"clear",value:function(t){t.clearRect(this.currentTranslation.x,this.currentTranslation.y,this.baseW+this.currentTranslation.x,this.baseH+this.currentTranslation.y)}},{key:"mapPositionToGrid",value:function(t){var e=this.canvas.getBoundingClientRect();return{i:Math.floor((t.x-e.left)/(this.cellW*this.scaleX)+this.currentTranslation.x/this.cellW),j:Math.floor((t.y-e.top)/(this.cellH*this.scaleY)+this.currentTranslation.y/this.cellH)}}},{key:"mapCellToCanvas",value:function(t){return{x:t.i*this.cellW,y:t.j*this.cellH}}},{key:"mapCanvasToCell",value:function(t){return{i:Math.floor(t.x/this.cellW),j:Math.floor(t.y/this.cellH)}}},{key:"changeTranslation",value:function(t,e,i,n){var o=t-this.halfColumns*this.cellW;if(o<0)o=0;else{var r=(i-this.columns)*this.cellW;o>r&&(o=r)}var a=e-this.halfRows*this.cellH;if(a<0)a=0;else{var s=(n-this.rows)*this.cellH;a>s&&(a=s)}return this.canvas.getContext("2d").translate(this.currentTranslation.x-o,this.currentTranslation.y-a),this.currentTranslation={x:o,y:a},this.currentTranslation}},{key:"getCurrentTranslation",value:function(){return this.currentTranslation}},{key:"resetTranslation",value:function(){this.canvas.getContext("2d").translate(this.currentTranslation.x,this.currentTranslation.y),this.currentTranslation={x:0,y:0}}},{key:"getBoundariesX",value:function(t,e){var i=Math.floor(t/this.cellW),n=i-this.halfColumns-1,o=i+this.halfColumns+1;return this.checkBoundariesLimit(n,o,e)}},{key:"getBoundariesY",value:function(t,e){var i=Math.floor(t/this.cellH),n=i-this.halfRows-1,o=i+this.halfRows+1;return this.checkBoundariesLimit(n,o,e)}},{key:"checkBoundariesLimit",value:function(t,e,i){return t<0&&(e-=t,t=0),e>=i&&(t-=e-i+1,e=i-1),{min:t,max:e}}}]),t}(),Utils;!function(t){function e(t){return null===t||void 0===t||("string"==typeof t?""===t:"object"===(void 0===t?"undefined":_typeof(t))&&"size"in t?0===t.size:(t.constructor===Array||t.constructor===String)&&0===t.length)}function i(){return(new Date).getTime()}function n(t,e){function i(t,e,i){n.set(e,t)}var n=new Map;return e.forEach(i),t.forEach(i),n}function o(t,e){return{i:t%e,j:Math.floor(t/e)}}function r(t,e){return t.i+t.j*e}function a(t,e){return(t&e)===e}function s(t,e,i,n){var o=0;return o|=t?BlockDirection.UP:0,o|=e?BlockDirection.DOWN:0,o|=i?BlockDirection.LEFT:0,o|=n?BlockDirection.RIGHT:0}function l(t,e){return c(t)===e}function c(t){switch(t){case 0:return 1;case 1:return 0;case 2:return 3;case 3:return 2}return 4}function u(t,e){var i=t.i-e.i,n=t.j-e.j;return Math.abs(i)>Math.abs(n)?i>0?3:2:n>0?1:n<0?0:4}function h(){return Math.random()>=.5}t.isEmpty=e,t.now=i,t.mergeMaps=n,t.gidToCell=o,t.cellToGid=r,t.isBlocked=a,t.getBlock=s,t.isDirectionsOpposed=l,t.getOpposedDirections=c,t.getDirection=u,t.getRandomBoolean=h}(Utils||(Utils={}));var MapManager;!function(t){function e(t,e,i){Resource.load(t+"",4,function(n){if(Utils.isEmpty(n))console.error("Error while loading map: "+t),i(null);else try{var o=JSON.parse(n);i(o)}catch(n){"SyntaxError"===n.name?console.error("Error while parsing map: "+t):"TypeError"===n.name?console.error("Error while reading map: "+t):console.error(n),Errors.showError(e.getContext("2d")),i(null)}})}function i(t,e,i,n,o,r,a,s,l){if(!Utils.isEmpty(i.data))for(var c=r;c<=a;c++)for(var u=s;u<=l;u++){var h=u+c*e.width;if(i.data.length<h)return;var d=i.data[h];if(null!==d){var p=Utils.gidToCell(d,Math.floor(e.tileset.imagewidth/t.cellW));o.drawImage(n,Math.floor(p.i*t.cellW),Math.floor(p.j*t.cellH),t.cellW,t.cellH,Math.floor(u*t.cellW),Math.floor(c*t.cellH),t.cellW,t.cellH)}}}function n(t,e,i,n,o,r){}function o(t,e,i,n,o,r,a,s){for(var l=a;l<=s;l++)for(var c=o;c<=r;c++)if(!Utils.isEmpty(n)){if(n.showBlocks&&!Utils.isEmpty(t)&&!Utils.isEmpty(t.blocks)){i.save(),i.globalAlpha=.9,i.fillStyle=Constant.Color.YELLOW;var u=Math.floor(3),h=t.blocks[c*t.width+l];h>0&&(Utils.isBlocked(h,BlockDirection.UP)&&i.fillRect((l+.5)*e.cellW-u,c*e.cellH,6,6),Utils.isBlocked(h,BlockDirection.DOWN)&&i.fillRect((l+.5)*e.cellW-u,(c+1)*e.cellH-6,6,6),Utils.isBlocked(h,BlockDirection.LEFT)&&i.fillRect(l*e.cellW,(c+.5)*e.cellH-u,6,6),Utils.isBlocked(h,BlockDirection.RIGHT)&&i.fillRect((l+1)*e.cellW-6,(c+.5)*e.cellH-u,6,6)),i.restore()}n.showGrid&&(i.strokeStyle=Constant.Color.RED,i.strokeRect(l*e.cellW,c*e.cellH,e.cellW,e.cellH)),n.showEditorGrid&&(i.save(),i.globalAlpha=.4,i.strokeStyle=Constant.Color.GREY,i.strokeRect(l*e.cellW,c*e.cellH,e.cellW,e.cellH),i.restore()),n.showCellNumbers&&(i.fillStyle=Constant.Color.RED,i.font="bold 10px Arial",i.fillText(l+","+c,l*e.cellW+1,c*e.cellH+10))}}function r(t,e,i){if(!Utils.isEmpty(i)&&i.enableSelection&&!Utils.isEmpty(i.selectPointStart)){var n=i.selectPointStart.x*t.cellW,o=i.selectPointStart.y*t.cellH,r=void 0,a=void 0;if(Utils.isEmpty(i.selectPointEnd))a=t.cellH,r=t.cellW;else{var s=i.selectPointEnd.x*t.cellW,l=i.selectPointEnd.y*t.cellH;n>s?(r=n-s,n=s):r=s-n,o>l?(a=o-l,o=l):a=l-o,r+=t.cellW,a+=t.cellH}e.save(),e.strokeStyle=Constant.Color.RED,e.lineWidth=3,e.strokeRect(n,o,r,a),e.restore()}}function a(t,e,i){var n=t.width,o=i,r=t.height,a=e;if(!(n===o&&r===a||Utils.isEmpty(t))){var s=Math.min(n,o);if(o<n)var l=n-o;else for(var c=[],u=0;u<o-n;u++)c[u]=null;for(var h=0;h<t.layers.length;h++){var d=t.layers[h];if(!Utils.isEmpty(d.data)){if(n!==o)for(var p=0;p<r;p++)Utils.isEmpty(l)?Array.prototype.splice.apply(d.data,[s+p*o,0].concat(c)):d.data.splice(s+p*o,l);if(r>a&&(d.data.length=o*a),r<a){for(var f=[],g=0;g<o-n;g++)f[g]=null;for(var v=n;v<o;v++)d.data.concat(f)}}}t.height=e,t.width=i}}function s(t){var e=[];if(!Utils.isEmpty(t.layers))for(var i=0;i<t.layers.length;i++){var n=t.layers[i];Utils.isEmpty(n.objects)||(e=e.concat(n.objects))}return e}function l(t){if(!Utils.isEmpty(t.layers)&&!Utils.isEmpty(t.tileset.blocks)){t.blocks=[];for(var e=0;e<t.height*t.width;e++)t.blocks[e]=0;for(var i=0;i<t.layers.length;i++){var n=t.layers[i];if(!Utils.isEmpty(n.data))for(var o=0;o<n.data.length;o++){var r=n.data[o],a=0;null!==r&&r<t.tileset.blocks.length&&(a=t.tileset.blocks[r]),t.blocks[o]|=a}}}}function c(t,e,i,n){switch(n){case 0:return Utils.isBlocked(t.blocks[i*t.width+e],BlockDirection.UP)||Utils.isBlocked(t.blocks[(i-1)*t.width+e],BlockDirection.DOWN);case 1:return Utils.isBlocked(t.blocks[i*t.width+e],BlockDirection.DOWN)||Utils.isBlocked(t.blocks[(i+1)*t.width+e],BlockDirection.UP);case 2:return Utils.isBlocked(t.blocks[i*t.width+e],BlockDirection.LEFT)||Utils.isBlocked(t.blocks[i*t.width+e-1],BlockDirection.RIGHT);case 3:return Utils.isBlocked(t.blocks[i*t.width+e],BlockDirection.RIGHT)||Utils.isBlocked(t.blocks[i*t.width+e+1],BlockDirection.LEFT)}return!1}function u(e,i,n){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:d.BASIC,r=n.i-i.i,a=n.j-i.j;if(0===r&&0===a)return 4;var s=void 0;switch(o){case d.BASIC:Math.abs(r)>Math.abs(a)?(s=r>0?3:2,t.isDirectionBlocked(e,i.i,i.j,s)&&(s=a>0?1:0)):(s=a>0?1:0,t.isDirectionBlocked(e,i.i,i.j,s)&&(s=r>0?3:2)),t.isDirectionBlocked(e,i.i,i.j,s)?s=4:(ActorManager.addDirectionToPath(i,s,3),3===i.path.length&&i.path[0]===i.path[2]&&Utils.isDirectionsOpposed(i.path[0],i.path[1])&&(s=4));break;case d.D_STAR_LITE:var l,c,u,h,p,f,g,v=function(t){return[Math.min(k(t),_(t))+S(p,t)+B,Math.min(k(t),_(t))]},y=function(t){k(t)!==_(t)?(t.key=v(t),x(t)):P(t)&&U(t)},m=function(t,e){var i=Utils.cellToGid(t.cell,O);u[i]=e},E=function(t,e){var i=Utils.cellToGid(t.cell,O);h[i]=e},k=function(t){var e=Utils.cellToGid(t.cell,O);return u[e]},_=function(t){var e=Utils.cellToGid(t.cell,O);return h[e]},T=function(t){var i=Utils.cellToGid(t.cell,e.width);l.length;var n=[];return i-1>0&&n.push(l[i-1]),i+1<l.length&&n.push(l[i+1]),i-e.width>0&&n.push(l[i-e.width]),i+e.width<l.length&&n.push(l[i+e.width]),n},b=function(t){var i=Utils.cellToGid(t.cell,e.width),n=[];return i-1>0&&n.push(l[i-1]),i+1<l.length&&n.push(l[i+1]),i-e.width>0&&n.push(l[i-e.width]),i+e.width<l.length&&n.push(l[i+e.width]),n},w=function(t,i){var n=e.blocks[i.cell.i+i.cell.j*e.width];if(0!==n){var o=void 0;if(o=t.cell.i>i.cell.i?BlockDirection.RIGHT:t.cell.i<i.cell.i?BlockDirection.LEFT:t.cell.j>i.cell.j?BlockDirection.DOWN:BlockDirection.UP,Utils.isBlocked(n,o))return I}if(0!==(n=e.blocks[t.cell.i+t.cell.j*e.width])){var r=void 0;if(r=t.cell.i>i.cell.i?BlockDirection.LEFT:t.cell.i<i.cell.i?BlockDirection.RIGHT:t.cell.j>i.cell.j?BlockDirection.UP:BlockDirection.DOWN,Utils.isBlocked(n,r))return I}return 1},S=function(t,e){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)},M=function(t,e){return t[0]===e[0]&&t[1]===e[1]?0:t[0]>t[0]||t[0]===e[0]&&t[1]>e[1]?1:-1},C=function(t,e){return t.cell.i===e.cell.i&&t.cell.j===e.cell.j},P=function(t){var e=!0,i=!1,n=void 0;try{for(var o,r=c[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){var a=o.value;if(C(t,a))return!0}}catch(t){i=!0,n=t}finally{try{!e&&r.return&&r.return()}finally{if(i)throw n}}return!1},x=function(t){var e=!0,i=!1,n=void 0;try{for(var o,r=c[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){var a=o.value;if(C(t,a))return void(a.key=t.key)}}catch(t){i=!0,n=t}finally{try{!e&&r.return&&r.return()}finally{if(i)throw n}}c.push(t)},U=function(t){var e=[],i=!0,n=!1,o=void 0;try{for(var r,a=c[Symbol.iterator]();!(i=(r=a.next()).done);i=!0){var s=r.value;C(t,s)||e.push(s)}}catch(t){n=!0,o=t}finally{try{!i&&a.return&&a.return()}finally{if(n)throw o}}c=e},L=function(){var t=void 0,e=!0,i=!1,n=void 0;try{for(var o,r=c[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){var a=o.value;(void 0===t||M(a.key,t.key)<0)&&(t=a)}}catch(t){i=!0,n=t}finally{try{!e&&r.return&&r.return()}finally{if(i)throw n}}return void 0===t&&(t={cell:void 0,key:[I,I]}),t},I=9999,B=void 0,O=e.width;p={cell:i},f={cell:n},Utils.isEmpty(e.dstarlitecache)||C(e.dstarlitecache.s_goal,f)||(e.dstarlitecache=void 0),Utils.isEmpty(e.dstarlitecache)?(function(){g=p,l=[];for(var t=0;t<e.height;t++)for(var i=0;i<e.width;i++){var n={cell:{i:i,j:t}};l.push(n)}u=[],h=[],c=[],B=0;var o=!0,r=!1,a=void 0;try{for(var s,d=l[Symbol.iterator]();!(o=(s=d.next()).done);o=!0){var v=s.value;m(v,I),E(v,I),E(f,0);var y=f;y.key=[S(p,f),0],c.push(y)}}catch(t){r=!0,a=t}finally{try{!o&&d.return&&d.return()}finally{if(r)throw a}}}(),function(){for(var t=L();M(t.key,v(p))<0||_(p)>k(p);){var e=t,i=t.key,n=v(e);if(i<n)e.key=n,x(e);else if(k(e)>_(e)){m(e,_(e)),U(e);var o=!0,r=!1,a=void 0;try{for(var s,l=b(e)[Symbol.iterator]();!(o=(s=l.next()).done);o=!0){var c=s.value;C(c,f)||E(e,Math.min(_(c),w(c,e)+k(e))),y(c)}}catch(t){r=!0,a=t}finally{try{!o&&l.return&&l.return()}finally{if(r)throw a}}}else{var u=k(e);m(e,I);var h=b(e);h.push(e);var d=!0,g=!1,S=void 0;try{for(var P,B=h[Symbol.iterator]();!(d=(P=B.next()).done);d=!0){var O=P.value;if(_(O)===w(O,e)+u&&!C(O,f)){var W=void 0,j=!0,D=!1,A=void 0;try{for(var R,G=T(O)[Symbol.iterator]();!(j=(R=G.next()).done);j=!0){var F=R.value,H=w(O,F)+k(F);(void 0===W||W>H)&&(W=H)}}catch(t){D=!0,A=t}finally{try{!j&&G.return&&G.return()}finally{if(D)throw A}}E(O,W)}y(O)}}catch(t){g=!0,S=t}finally{try{!d&&B.return&&B.return()}finally{if(g)throw S}}}}}()):(l=e.dstarlitecache.S,c=e.dstarlitecache.U,u=e.dstarlitecache.g,h=e.dstarlitecache.rhs);var W=void 0,j=void 0,D=!0,A=!1,R=void 0;try{for(var G,F=T(p)[Symbol.iterator]();!(D=(G=F.next()).done);D=!0){var H=G.value,N=w(p,H)+k(H);(void 0===j||j>N)&&(j=N,W=H)}}catch(t){A=!0,R=t}finally{try{!D&&F.return&&F.return()}finally{if(A)throw R}}p=W;Utils.getDirection(p.cell,i);e.dstarlitecache.S=l,e.dstarlitecache.U=c,e.dstarlitecache.s_goal=f,e.dstarlitecache.g=u,e.dstarlitecache.rhs=h}return s}function h(t){return{id:null,name:t,height:20,width:25,layers:[{data:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],type:"tilelayer",x:0,y:0},{type:"tilelayer",x:0,y:0},{type:"tilelayer",x:0,y:0},{type:"tilelayer",x:0,y:0},{objects:[{gid:6,height:32,id:1,name:"signor evento",rotation:0,visible:!0,width:32,i:4,j:2}],opacity:1,type:"objectgroup",x:0,y:0}],nextobjectid:2,tile:"002-Woods01.png"}}var d=void 0;!function(t){t[t.BASIC=0]="BASIC",t[t.D_STAR_LITE=1]="D_STAR_LITE"}(d=t.PathfinderEnum||(t.PathfinderEnum={})),t.loadMap=e,t.renderLayer=i,t.renderGlobalEffects=n,t.renderUI=o,t.renderGlobalUI=r,t.resizeMap=a,t.getActors=s,t.loadBlocks=l,t.isDirectionBlocked=c,t.pathFinder=u,t.getNewMap=h}(MapManager||(MapManager={}));var ActorManager;!function(t){function e(t,e){}function i(t,e,i){e.speed=i,e.mSpeed=e.speed*t.cellH/1e3}function n(t){return Utils.isEmpty(t.mSpeed)?p:t.mSpeed}function o(t,e,i,n){e.newTarget=t.mapCellToCanvas({i:i,j:n})}function r(t,e,i){var n=void 0;if(Utils.isEmpty(e.charaset)?Utils.isEmpty(e.gid):n=Resource.loadImageFromCache(e.charaset,0),Utils.isEmpty(n)&&(n=Resource.loadDefaultImage(0)),!Utils.isEmpty(n)){var o=Math.floor(n.width/4),r=Math.floor(n.height/4),a=0;if(Utils.isEmpty(e.target))e.animationStartTime=void 0;else{Utils.isEmpty(e.animationStartTime)&&(e.animationStartTime=Utils.now());var s=Utils.now()-e.animationStartTime,l=f;switch(Utils.isEmpty(e.frequency)||(l=e.frequency),Math.floor(s*l%4)){case 1:a=o;break;case 2:a=2*o;break;case 3:a=3*o}}var c=0;switch(e.direction){case 2:c=r;break;case 3:c=2*r;break;case 0:c=3*r}var u=e.position.x+Math.floor((t.cellW-o)/2),h=e.position.y+Math.floor(2*o/3-r),d=i.globalAlpha;Utils.isEmpty(e.opacity)||(i.globalAlpha=e.opacity),i.drawImage(n,a,c,o,r,u,h,o,r),i.globalAlpha=d}}function a(){return{id:0,name:"",i:0,j:0}}function s(){var t=a();return t.name="Hero",t.charaset="fart.png",t.i=0,t.j=1,t}function l(t,e,i,n,o){return!(!Utils.isEmpty(t.visible)&&!t.visible)&&(!(!Utils.isEmpty(t.opacity)&&0===t.opacity)&&(t.i>=n&&t.i<=o&&t.j>=e&&t.j<=i))}function c(t,e,i,o,r){var a=arguments.length>5&&void 0!==arguments[5]?arguments[5]:0;if(!Utils.isEmpty(i.movementStartTime)){0===a&&(a=Utils.now()-i.movementStartTime);var s={i:i.target.x/e.cellW,j:i.target.y/e.cellH},l=MapManager.pathFinder(t,i,s),h=0,d=0,p=void 0;switch(l){case 2:p=h=Math.min(e.cellW,Math.floor(n(i)*a)),h*=-1;break;case 3:p=h=Math.min(e.cellW,Math.floor(n(i)*a));break;case 0:p=d=Math.min(e.cellH,Math.floor(n(i)*a)),d*=-1;break;case 1:p=d=Math.min(e.cellH,Math.floor(n(i)*a));break;case 4:u(i)}if(4!==l&&(i.direction=l,i.position.x=i.i*e.cellW+h,i.position.y=i.j*e.cellH+d,o(h,d),p===e.cellW)){i.movementStartTime=Utils.now(),a-=p/n(i);var f=e.mapCanvasToCell(i.position);i.i=f.i,i.j=f.j,r(h,d),(!Utils.isEmpty(i.newTarget)||i.position.x===i.target.x&&i.position.y===i.target.y)&&u(i)}}!Utils.isEmpty(i.newTarget)&&Utils.isEmpty(i.movementStartTime)&&(i.target=i.newTarget,i.newTarget=void 0,i.movementStartTime=Utils.now(),c(t,e,i,o,r,a))}function u(t){t.path=void 0,t.movementStartTime=void 0,t.target=void 0}function h(t,e){return Utils.isEmpty(e.position)&&(e.position={x:e.i*t.cellW,y:e.j*t.cellH}),Utils.isEmpty(e.speed)||this.setSpeed(e,e.speed),e}function d(t,e,i){void 0===t.path&&(t.path=[]),t.path[t.path.length-1]!==e&&t.path.push(e),!Utils.isEmpty(i)&&t.path.length>i&&t.path.shift()}var p=.128,f=.006;t.update=e,t.setSpeed=i,t.getMSpeed=n,t.startMovement=o,t.render=r,t.getNewActor=a,t.getNewHero=s,t.isVisible=l,t.manageMovements=c,t.initTransientData=h,t.addDirectionToPath=d}(ActorManager||(ActorManager={}));var nextAnimationFrame=window.requestAnimationFrame||function(t){window.setTimeout(this.mainGameLoop,40)},AbstractScene=function(){function t(e){_classCallCheck(this,t),this.renderingConfiguration=new RenderConfiguration,this.grid=e,this.paused=!1,this.focus=this.grid.mapCellToCanvas({i:0,j:0}),this.pointer={i:0,j:0}}return _createClass(t,[{key:"start",value:function(t){this.changeScale(t),this.mainGameLoop()}},{key:"mainGameLoop",value:function(){var t=this;if(nextAnimationFrame(function(){t.mainGameLoop()}),!this.paused&&!1!==this.mainGameLoop_pre()){var e=this.grid.getBoundariesY(this.focus.y,this.getSceneHeight()),i=e.min,n=e.max,o=this.grid.getBoundariesX(this.focus.x,this.getSceneWidth()),r=o.min,a=o.max;Utils.isEmpty(this.map)||Utils.isEmpty(this.map.tileset)||Utils.isEmpty(this.map.tileset.imageData)||this.renderLayers(this.map,this.map.tileset.imageData,this.context,i,n,r,a),MapManager.renderGlobalEffects(this.grid,this.context,i,n,r,a),this.renderTopLayerElements(i,n,r,a),MapManager.renderGlobalUI(this.grid,this.context,this.renderingConfiguration),this.renderFocus(),this.renderPointer(),this.mainGameLoop_post(o,e)}}},{key:"mainGameLoop_pre",value:function(){return this.grid.clear(this.context),!0}},{key:"mainGameLoop_post",value:function(t,e){}},{key:"renderPointer",value:function(){if(null!=this.pointer.i&&null!=this.pointer.j){var t=this.grid.mapCellToCanvas(this.pointer);this.context.save(),this.context.beginPath(),this.context.fillStyle=Constant.Color.YELLOW,this.context.arc(t.x+Math.floor(this.grid.cellW/2),t.y+Math.floor(this.grid.cellH/2),18,0,Constant.DOUBLE_PI),this.context.closePath(),this.context.globalAlpha=.4,this.context.fill(),this.context.restore()}}},{key:"renderFocus",value:function(){null!=this.focus.x&&null!=this.focus.y&&this.renderingConfiguration.showFocus&&(this.context.save(),this.context.beginPath(),this.context.fillStyle=Constant.Color.BLACK,this.context.arc(this.focus.x+Math.floor(this.grid.cellW/2),this.focus.y+Math.floor(this.grid.cellH/2),15,0,Constant.DOUBLE_PI),this.context.closePath(),this.context.fill(),this.context.restore())}},{key:"toggleGrid",value:function(t){this.renderingConfiguration.showGrid=null!=t?t:!this.renderingConfiguration.showGrid}},{key:"toggleGridMode",value:function(){this.renderingConfiguration.showGrid?this.renderingConfiguration.showBlocks?(this.toggleGrid(),this.toggleBlocks()):this.toggleBlocks():this.toggleGrid()}},{key:"toggleCellNumbering",value:function(t){this.renderingConfiguration.showCellNumbers=null!=t?t:!this.renderingConfiguration.showCellNumbers}},{key:"toggleFocus",value:function(t){this.renderingConfiguration.showFocus=null!=t?t:!this.renderingConfiguration.showFocus}},{key:"toggleBlocks",value:function(t){this.renderingConfiguration.showBlocks=null!=t?t:!this.renderingConfiguration.showBlocks}},{key:"toggleAntialiasing",value:function(t){this.renderingConfiguration.enableAntialiasing=null!=t?t:!this.renderingConfiguration.enableAntialiasing,"mozImageSmoothingEnabled"in this.context&&(this.context.mozImageSmoothingEnabled=this.renderingConfiguration.enableAntialiasing),"webkitImageSmoothingEnabled"in this.context&&(this.context.webkitImageSmoothingEnabled=this.renderingConfiguration.enableAntialiasing),"msImageSmoothingEnabled"in this.context&&(this.context.msImageSmoothingEnabled=this.renderingConfiguration.enableAntialiasing),"imageSmoothingEnabled"in this.context&&(this.context.imageSmoothingEnabled=this.renderingConfiguration.enableAntialiasing)}},{key:"updatePointer",value:function(t,e){this.pointer={i:t,j:e}}},{key:"moveFocus",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;if(null!=t)switch(t){case 0:this.focus.y-=+this.grid.cellH;break;case 1:this.focus.y+=+this.grid.cellH;break;case 2:this.focus.x-=+this.grid.cellW;break;case 3:this.focus.x+=+this.grid.cellW}this.grid.changeTranslation(this.focus.x,this.focus.y,this.map.width,this.map.height)}},{key:"resetTranslation",value:function(){this.grid.resetTranslation()}},{key:"changeScale",value:function(t){this.context=t.getContext("2d"),this.context.scale(this.grid.scaleX,this.grid.scaleY)}},{key:"changeMap",value:function(t,e){var i=this;Utils.isEmpty(t)&&(console.error("initialized map"),console.trace()),i.map=t,i.changeTile(t.tile,function(t){setTimeout(function(){MapManager.loadBlocks(t.map)}),e(t)})}},{key:"changeTile",value:function(t,e){var i=this;TilesetManager.loadTileset(t,this.context,function(n){i.map.tileset=n,Resource.load(t,3,function(t){i.map.tileset.imageData=t[0],e(i)})})}},{key:"getSceneHeight",value:function(){return this.map.height}},{key:"getSceneWidth",value:function(){return this.map.width}},{key:"renderLayers",value:function(t,e,i,n,o,r,a){if(!Utils.isEmpty(t))for(var s=Constant.MapLayer.LOW;s<=Constant.MapLayer.EVENTS;s++){var l=t.layers[s];Utils.isEmpty(l.opacity)||(i.globalAlpha=l.opacity),this.renderLayer(s,e,i,n,o,r,a),i.globalAlpha=1}}},{key:"renderLayer",value:function(t,e,i,n,o,r,a){this.renderInterLayerElements(t,n,o,r,a);var s=this.map.layers[t];MapManager.renderLayer(this.grid,this.map,s,e,i,n,o,r,a)}},{key:"togglePause",value:function(t){this.paused=null!=t?t:!this.paused}},{key:"onFocusCellChange",value:function(){}},{key:"onFocusPixelChange",value:function(t,e){}}]),t}(),SaveManager;!function(t){function e(t){return{id:0,map:0,hero:ActorManager.getNewHero()}}t.getNewSave=e}(SaveManager||(SaveManager={}));var TilesetManager;!function(t){function e(t,e,i){Resource.load(t+"",6,function(n){if(Utils.isEmpty(n))console.error("Error while loading tileset: "+t),i(null);else try{var o=JSON.parse(n);i(o)}catch(n){"SyntaxError"===n.name?console.error("Error while parsing tileset: "+t):"TypeError"===n.name?console.error("Error while reading tileset: "+t):console.error(n),Errors.showError(e),i(null)}})}function i(t){return{firstgid:1,image:"002-Woods01.png",imageheight:800,imagewidth:256,name:"Bosco",blocks:null,over:null}}t.loadTileset=e,t.getNewTileset=i}(TilesetManager||(TilesetManager={}));var Compatibility;!function(t){function e(){i(),n(),o()}function i(){var t=document.createElement("canvas");return!(!t.getContext||!t.getContext("2d"))||(console.error("HTML5 canvas is not supported"),!1)}function n(){return"serviceWorker"in navigator||(console.error("Service Workers are not supported"),!1)}function o(){return"Worker"in window||(console.error("Web Workers are not supported"),!1)}t.check=e,t.serviceWorker=n,t.webWorker=o}(Compatibility||(Compatibility={}));var Errors;!function(t){function e(t){Utils.isEmpty(this.context)||Utils.isEmpty(this.grid)||this.grid.clear(this.context),t.fillStyle="#000000",t.font="bold 20px Arial",t.fillText("An error occurred :(",60,60)}t.showError=e}(Errors||(Errors={}));var Input;!function(t){function e(t,e,n,o,r,a,s,l,c,u,h,d,p,f,g){function v(t){var i={x:t.clientX,y:t.clientY};return e.mapPositionToGrid(i)}var y,m=!1;n[i.SPACE]=function(t){m?(h(),m=!1):(u(),m=!0),t.preventDefault()};var E=!1;t.addEventListener("click",function(t){var e=v(t);r(e.i,e.j)}),t.addEventListener("mousemove",function(t){var e=v(t);E?l(e.i,e.j,t.buttons):c(e.i,e.j)}),t.addEventListener("mousedown",function(t){E=!0;var e=v(t);a(e.i,e.j,t.buttons)}),t.addEventListener("mouseup",function(t){E=!1;var e=v(t);s(e.i,e.j,t.buttons)}),t.addEventListener("mouseout",function(t){E?l(null,null,t.buttons):c(null,null)}),t.addEventListener("contextmenu",function(t){t.preventDefault();var e=v(t);p(e.i,e.j)}),t.addEventListener("dblclick",function(t){var e=v(t);f(e.i,e.j)}),t.addEventListener("wheel",function(t){var e=v(t);g(e.i,e.j)}),t.addEventListener("touchstart",function(t){var e=v(t);a(e.i,e.j)}),t.addEventListener("touchend",function(t){var e=v(t);l(null,null),s(e.i,e.j)}),t.addEventListener("touchcancel",function(t){var e=v(t);l(null,null),s(e.i,e.j)}),t.addEventListener("touchmove",function(t){var e=v(t);l(e.i,e.j)}),document.addEventListener("keydown",function(t){var e=n[t.keyCode+""];void 0!==e&&(t.preventDefault(),e(t)),y=t.keyCode}),document.addEventListener("keyup",function(t){t.keyCode===y&&o()}),document.addEventListener("visibilitychange",function(){document.hidden?(u(),m=!0):(h(),m=!1)}),window.addEventListener("resize",function(t){d()}),document.addEventListener("orientationchange",function(){d()})}var i=function t(){_classCallCheck(this,t)};i.UP="38",i.DOWN="40",i.LEFT="37",i.RIGHT="39",i.CTRL="17",i.ALT="18",i.ENTER="13",i.SPACE="32",i.CAPS="20",i.SHIFT="16",i.W="87",i.A="65",i.D="68",i.S="83",i.J="74",i.K="75",i.F1="112",i.F2="113",i.F3="114",i.F4="115",i.F5="116",i.F6="117",t.Keys=i;var n=function t(){_classCallCheck(this,t)};n.LEFT=1,n.RIGHT=2,n.MIDDLE=4,t.MouseButtons=n,t.init=e}(Input||(Input={}));var Workers;!function(t){function e(e){Compatibility.webWorker()&&(Utils.isEmpty(n)&&(n=new Worker(t.WEBWORKER_URL)),n.postMessage(e))}function i(){Compatibility.serviceWorker()&&navigator.serviceWorker.register(t.SERVICEWORKER_URL,t.SERVICEWORKER_OPTIONS).then(function(t){},function(t){console.warn("ServiceWorker registration failed: ",t)})}t.WEBWORKER_URL="workers/l4w-webworker.js",t.SERVICEWORKER_URL="workers/l4w-serviceworker.js",t.SERVICEWORKER_OPTIONS={scope:"../"};var n=void 0;t.launchWebWorker=e,t.registerServiceWorker=i}(Workers||(Workers={}));var DynamicGrid=function(t){function e(t,i){return _classCallCheck(this,e),_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i,GridTypeEnum.game))}return _inherits(e,t),_createClass(e,[{key:"deferredInit",value:function(t){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"deferredInit",this).call(this,t),this.canvasRatio=t.get("canvasRatio"),this.scaleStepX=this.cellW*Math.pow(2,-10),this.scaleStepY=this.cellH*Math.pow(2,-10)}},{key:"refresh",value:function(){var t=this.baseH/this.height(),i=this.baseW/this.width(),n=this.canvasRatio/(t>i?t:i);this.scaleX=n-n%this.scaleStepX,this.scaleY=n-n%this.scaleStepY,_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"refresh",this).call(this)}},{key:"width",value:function(){return window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth||0}},{key:"height",value:function(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight||0}}]),e}(AbstractGrid),DynamicScene=function(t){function e(t,i){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.FPS=20,n.refreshInterval=1e3/n.FPS,n.autoFPS=!0,n.secondFPS=0,n.countFPS=0,n.lastFPS=0,n.fpsPerformance=[22,21,20],n.context=i.getContext("2d"),n}return _inherits(e,t),_createClass(e,[{key:"mainGameLoop_pre",value:function(){if(!_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"mainGameLoop_pre",this).call(this))return!1;var t=this,i=Utils.now();if(Utils.isEmpty(this.hero)||(ActorManager.update(this.hero,i),ActorManager.manageMovements(this.map,this.grid,this.hero,function(e,i){t.grid.changeTranslation(t.focus.x+e,t.focus.y+i,t.map.width,t.map.height)},function(e,i){t.focus.x+=e,t.focus.y+=i})),!Utils.isEmpty(this.events)){var n=!0,o=!1,r=void 0;try{for(var a,s=this.events[Symbol.iterator]();!(n=(a=s.next()).done);n=!0){var l=a.value;ActorManager.update(l,i),ActorManager.manageMovements(this.map,this.grid,l,function(){},function(){})}}catch(t){o=!0,r=t}finally{try{!n&&s.return&&s.return()}finally{if(o)throw r}}}return!0}},{key:"mainGameLoop_post",value:function(t,i){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"mainGameLoop_post",this).call(this,t,i),this.context.fillStyle="#000000",this.context.font="bold 40px Arial",this.context.fillText("(it's not ready yet)",this.grid.getCurrentTranslation().x+160,this.grid.getCurrentTranslation().y+260),this.renderFPS()}},{key:"toggleFPS",value:function(t){this.renderingConfiguration.showFPS=null!=t?t:!this.renderingConfiguration.showFPS}},{key:"renderFPS",value:function(){var t=Math.floor(Utils.now()/1e3);if(t===this.secondFPS)this.countFPS++;else if(this.lastFPS=this.countFPS,this.countFPS=1,this.secondFPS=t,!0===this.autoFPS){this.fpsPerformance.shift(),this.fpsPerformance[2]=this.lastFPS;var e=(this.fpsPerformance[0]+this.fpsPerformance[1]+this.fpsPerformance[2])/3;this.FPS=Math.ceil(e)+2}this.renderingConfiguration.showFPS&&(this.context.fillStyle=Constant.Color.RED,this.context.font="bold 18px Arial",this.context.fillText(""+this.lastFPS,this.grid.getCurrentTranslation().x+10,this.grid.getCurrentTranslation().y+20))}},{key:"renderInterLayerElements",value:function(t,e,i,n,o){if(t===Constant.MapLayer.EVENTS&&(ActorManager.isVisible(this.hero,e,i,n,o)&&ActorManager.render(this.grid,this.hero,this.context),!Utils.isEmpty(this.events))){var r=!0,a=!1,s=void 0;try{for(var l,c=this.events[Symbol.iterator]();!(r=(l=c.next()).done);r=!0){var u=l.value;ActorManager.isVisible(u,e,i,n,o)&&ActorManager.render(this.grid,u,this.context)}}catch(t){a=!0,s=t}finally{try{!r&&c.return&&c.return()}finally{if(a)throw s}}}}},{key:"renderTopLayerElements",value:function(t,e,i,n){MapManager.renderUI(this.map,this.grid,this.context,this.renderingConfiguration,t,e,i,n)}},{key:"loadSave",value:function(t,e){var i=this,n=void 0,o=void 0;if(Utils.isEmpty(t)){if(!Utils.isEmpty(this.map))return void e(!1);n="0",o=ActorManager.getNewHero()}else n=t.map,o=t.hero;this.hero=ActorManager.initTransientData(this.grid,o),MapManager.loadMap(n,this.context.canvas,function(t){i.changeMap(t,function(){i.resetTranslation(),i.focus=i.grid.mapCellToCanvas(o),e(!0)})})}},{key:"getSave",value:function(){return Utils.isEmpty(this.map)||Utils.isEmpty(this.focus)?null:{id:0,map:this.map.id,hero:this.hero}}},{key:"startMovement",value:function(t,e){ActorManager.startMovement(this.grid,this.hero,t,e)}}]),e}(AbstractScene),Game;!function(t){function e(t){Compatibility.check(),Workers.registerServiceWorker(),new DynamicGrid(t,function(e){a=new DynamicScene(e,t),r(t,a,e),o(t,function(e){a.loadSave(e,function(e){a.start(t),a.moveFocus()})})})}function i(){o(document.getElementById("canvas1"),function(t){a.loadSave(t,function(t){a.moveFocus(),t?console.log("Save loaded successfully"):console.log("Save not found")})})}function n(){var t="0",e=a.getSave();Utils.isEmpty(e)||(t=e.id+""),Resource.save(t,JSON.stringify(e),5,function(t){t&&console.log("Save saved successfully")})}function o(t,e){var i="0",n=a.getSave();Utils.isEmpty(n)||(i=n.id+""),Resource.load(i,5,function(i){if(Utils.isEmpty(i))e(null);else try{var n=JSON.parse(i);e(n)}catch(i){"SyntaxError"===i.name?console.error("Error while parsing save"):"TypeError"===i.name?console.error("Error while reading save"):console.error(i),Errors.showError(t.getContext("2d")),e(null)}})}function r(t,e,i){function n(t,i){e.startMovement(t,i)}var o=new Map;o[Input.Keys.W]=function(t){e.moveFocus(0)},o[Input.Keys.S]=function(t){e.moveFocus(1)},o[Input.Keys.A]=function(t){e.moveFocus(2)},o[Input.Keys.D]=function(t){e.moveFocus(3)},o[Input.Keys.F1]=function(t){e.toggleFPS()},o[Input.Keys.F2]=function(t){e.toggleGridMode()},o[Input.Keys.F3]=function(t){e.toggleCellNumbering()},o[Input.Keys.F4]=function(t){e.toggleFocus()},o[Input.Keys.F5]=function(t){e.toggleBlocks(),t.preventDefault()},o[Input.Keys.F6]=function(t){e.toggleAntialiasing(),t.preventDefault()};var r=function(t,e){n(t,e)};Input.init(t,i,o,function(){},r,function(){},function(){},function(t,i){e.updatePointer(t,i)},function(t,i){e.updatePointer(t,i)},function(){console.log("pause"),e.togglePause(!0)},function(){console.log("unpause"),e.togglePause(!1)},function(){i.refresh(),e.changeScale(t),e.resetTranslation()},function(){console.log("rightClick")},function(){console.log("doubleClick")},function(){console.log("wheel")})}var a;t.start=e,t.load=i,t.save=n}(Game||(Game={}));var AbstractStaticScene=function(t){function e(t){_classCallCheck(this,e);var i=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i.renderingConfiguration.showEditorGrid=!0,i.renderingConfiguration.enableSelection=!0,i}return _inherits(e,t),_createClass(e,[{key:"mainGameLoop_pre",value:function(){return!!_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"mainGameLoop_pre",this).call(this)}},{key:"mainGameLoop_post",value:function(t,i){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"mainGameLoop_post",this).call(this,t,i)}},{key:"toggleEditorGrid",value:function(t){this.renderingConfiguration.showEditorGrid=null!=t?t:!this.renderingConfiguration.showEditorGrid}},{key:"renderPointer",value:function(){null!=this.pointer.i&&null!=this.pointer.j&&(this.context.save(),this.context.globalAlpha=.4,this.context.fillStyle=Constant.Color.YELLOW,this.context.fillRect(this.pointer.i*this.grid.cellW,this.pointer.j*this.grid.cellH,this.grid.cellW,this.grid.cellH),this.context.restore())}},{key:"select",value:function(t,e){null!=t&&null!=e&&(this.renderingConfiguration.selectPointStart={x:t,y:e},this.renderingConfiguration.selectPointEnd=null)}},{key:"selectEnd",value:function(t,e){null!=t&&null!=e&&(this.renderingConfiguration.selectPointEnd={x:t,y:e})}},{key:"cleanSelection",value:function(){this.renderingConfiguration.selectPointStart=null,this.renderingConfiguration.selectPointEnd=null}},{key:"getSelectionArea",value:function(){if(Utils.isEmpty(this.renderingConfiguration.selectPointStart))return null;var t,e,i=this.renderingConfiguration.selectPointStart.x,n=this.renderingConfiguration.selectPointStart.y;if(Utils.isEmpty(this.renderingConfiguration.selectPointEnd))t=this.renderingConfiguration.selectPointStart.x,e=this.renderingConfiguration.selectPointStart.y;else{if(t=this.renderingConfiguration.selectPointEnd.x,e=this.renderingConfiguration.selectPointEnd.y,i>t){var o=i;i=t,t=o}if(n>e){var r=n;n=e,e=r}}return{x1:i,y1:n,x2:t,y2:e}}}]),e}(AbstractScene),AbstractTileScene=function(t){function e(t,i,n){_classCallCheck(this,e);var o=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return o.height=Math.floor(i/t.cellH),o.width=Math.floor(n/t.cellW),o.renderingConfiguration.showBlocks=!0,o}return _inherits(e,t),_createClass(e,[{key:"select",value:function(t,i){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"select",this).call(this,t,i)}},{key:"updateSize",value:function(t,e){this.height=Math.floor(t/this.grid.cellH),this.width=Math.floor(e/this.grid.cellW)}},{key:"getSceneHeight",value:function(){return this.height}},{key:"getSceneWidth",value:function(){return this.width}},{key:"renderInterLayerElements",value:function(t,e,i,n,o){}},{key:"renderTopLayerElements",value:function(t,e,i,n){MapManager.renderUI(this.map,this.grid,this.context,this.renderingConfiguration,t,e,i,n)}}]),e}(AbstractStaticScene),MapperPage;!function(t){function e(){Compatibility.check(),$("#mapPanel").jstree({core:{animation:0,data:{url:base_path+"data/map",dataType:"json"},check_callback:!0},multiple:!1,plugins:["dnd","contextmenu"],themes:{dots:!1}});var t=document.getElementById("canvas1");$("#mapPanel").on("create_node.jstree rename_node.jstree delete_node.jstree",function(t,e){switch(t.type){case"create_node":d&&$("#mapPanel").jstree(!0).disable_node(e.node);case"rename_node":case"delete_node":u(!0,!1);break;default:console.log("Type: "+t.type)}}),$("#mapPanel").on("changed.jstree",function(e,i){switch(i.action){case"ready":return;case"delete_node":var n=$("#mapPanel").jstree(!0).get_prev_dom(i.node);return void $("#mapPanel").jstree(!0).select_node(n);case"model":case"select_node":h&&(h=!1),$("#mapDetailPanel").show();var o=c();Utils.isEmpty(o.data)&&(o.data={w:25,h:20,tile:"002-Woods01.png"}),$("#mapSizeW").val(o.data.w+""),$("#mapSizeH").val(o.data.h+""),$("#tiles").val(o.data.tile),TilePicker.loadTile(o.data.tile,function(e){Mapper.start(t,e,parseInt(o.id))});break;default:console.log("Action: "+i.action)}});var e=function(t){var e=+t.get("cellWidth")*+t.get("tileColumns")+2;$("#toolsPanel").width(e)};Resource.loadProperties(e),n(),o()}function i(){var t=c();t.data.w=$("#mapSizeW").val(),t.data.h=$("#mapSizeH").val(),Mapper.changeSize(t.data.h,t.data.w),u(!0)}function n(){$.getJSON(base_path+"data/resources/tiles.json",function(t){for(var e=$("#tiles"),i=0;i<t.length;i++)e.append("<option value='"+t[i].name+"'>"+t[i].desc+"</option>")})}function o(){$.getJSON(base_path+"news",function(t){$("#news")})}function r(){var t=$("#mapPanel").jstree(!0).get_selected(!0)[0];t.data.tile=$("#tiles").val(),TilePicker.loadTile(t.data.tile,function(e){Mapper.changeTile(t.data.tile,e)}),u(!0)}function a(){Mapper.saveMap(function(e){e?(t.changeEditState(!1),TilePicker.saveData(function(t){t||console.error("Salvataggio fallito")})):console.error("Salvataggio fallito")})}function s(){Mapper.reloadMap(),$("#mapPanel").jstree(!0).refresh(!1,!1)}function l(){return parseInt(c().id)}function c(){return $("#mapPanel").jstree(!0).get_selected(!0)[0]}function u(e){var i=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(d=e,document.title=e?t.PAGE_TITLE+"*":t.PAGE_TITLE,$("#saveButton")[0].disabled=!e,$("#reloadButton")[0].disabled=!e,i){var n=$("#mapPanel").jstree(!0).get_json("#",{flat:!0,no_state:!1,no_id:!1,no_children:!1,no_data:!1});$.each(n,function(t,i){e?$("#mapPanel").jstree("disable_node",i.id):$("#mapPanel").jstree("enable_node",i.id)})}}t.PAGE_TITLE=document.title,t.BUTTON_ID_MODE="mode",t.BUTTON_ID_LAYER="layer";var h=!0,d=!1;t.start=e,t.changeSize=i,t.loadNews=o,t.changeTile=r,t.save=a,t.reload=s,t.getActiveMap=l,t.changeEditState=u}(MapperPage||(MapperPage={}));var Mapper;!function(t){function e(e,i,n){Utils.isEmpty(t.mapper)||t.mapper.togglePause(!0),new StaticGrid(e,function(o){new MapperScene(o,function(r){a(e,r,o),s(e,r,o),TilePicker.setMapper(r),r.setTilePicker(i),t.mapper=r,MapManager.loadMap(n,e,function(i){t.mapper.changeMap(i,function(){t.mapper.start(e)})})})},GridTypeEnum.mapper)}function i(e,i){t.mapper.changeTile(e,function(t){}),t.mapper.setTilePicker(i)}function n(e,i){t.mapper.resizeMap(e,i)}function o(){var e=MapperPage.getActiveMap(),i=document.getElementById("canvas1");MapManager.loadMap(e,i,function(e){t.mapper.changeMap(e,function(){MapperPage.changeEditState(!1)})})}function r(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=MapperPage.getActiveMap(),i=JSON.stringify(this.mapper.getMap());Resource.save(e+"",i,4,function(e){null!==t&&t(e)})}function a(t,e,i){var n=new Map;n[Input.Keys.W]=function(t){e.moveFocus(0)},n[Input.Keys.S]=function(t){e.moveFocus(1)},n[Input.Keys.A]=function(t){e.moveFocus(2)},n[Input.Keys.D]=function(t){e.moveFocus(3)},n[Input.Keys.F2]=function(t){e.toggleEditorGrid()},n[Input.Keys.F3]=function(t){e.toggleCellNumbering()},n[Input.Keys.F4]=function(t){e.toggleFocus()},Input.init(t,i,n,function(){},function(){},function(t,i,n){n===Input.MouseButtons.LEFT?e.apply(t,i)&&MapperPage.changeEditState(!0):e.select(t,i)},function(t,i,n){n===Input.MouseButtons.LEFT&&e.selectEnd(t,i)},function(t,i,n){n===Input.MouseButtons.LEFT?e.apply(t,i)&&MapperPage.changeEditState(!0):e.selectEnd(t,i),e.updatePointer(t,i)},function(t,i){e.updatePointer(t,i)},function(){},function(){},function(){},function(t,i){e.cleanSelection()},function(){console.log("doubleClick")},function(){console.log("wheel")})}function s(t,e,i){var n=document.getElementById("zoom");n.onchange=function(o){i.selectScale(+n.value),i.refresh(),e.changeScale(t),e.resetTranslation()}}function l(e){document.getElementById(MapperPage.BUTTON_ID_MODE+"0").disabled=!1,document.getElementById(MapperPage.BUTTON_ID_MODE+"1").disabled=!1,document.getElementById(MapperPage.BUTTON_ID_MODE+e).disabled=!0,t.mapper.setEditMode(e)}function c(e){document.getElementById(MapperPage.BUTTON_ID_LAYER+"0").disabled=!1,document.getElementById(MapperPage.BUTTON_ID_LAYER+"1").disabled=!1,document.getElementById(MapperPage.BUTTON_ID_LAYER+"2").disabled=!1,document.getElementById(MapperPage.BUTTON_ID_LAYER+"3").disabled=!1,document.getElementById(MapperPage.BUTTON_ID_LAYER+e).disabled=!0,t.mapper.setActiveLayer(e)}t.start=e,t.changeTile=i,t.changeSize=n,t.reloadMap=o,t.saveMap=r,t.setMode=l,t.setActiveLayer=c}(Mapper||(Mapper={}));var MapperScene=function(t){function e(t,i){_classCallCheck(this,e);var n=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.activeLayer=Constant.MapLayer.MID,n.editMode=Constant.EditMode.APPLY,document.getElementById(MapperPage.BUTTON_ID_LAYER+n.activeLayer).disabled=!0,document.getElementById(MapperPage.BUTTON_ID_MODE+n.editMode).disabled=!0,i(n),n}return _inherits(e,t),_createClass(e,[{key:"renderPointer",value:function(){if(null!=this.pointer.i&&null!=this.pointer.j){var t=this.getSelectionArea();Utils.isEmpty(t)?_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"renderPointer",this).call(this):(this.context.save(),this.context.globalAlpha=.4,this.context.fillStyle=Constant.Color.GREY,this.context.fillRect(this.pointer.i*this.grid.cellW,this.pointer.j*this.grid.cellH,(t.x2-t.x1+1)*this.grid.cellW,(t.y2-t.y1+1)*this.grid.cellH),this.context.restore())}}},{key:"select",value:function(t,i){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"select",this).call(this,t,i)}},{key:"apply",value:function(t,e){var i=!1,n=this.tilePicker.getSelectionArea(),o=t+e*this.map.width;switch(Utils.isEmpty(this.map.layers[this.activeLayer].data)&&(this.map.layers[this.activeLayer].data=[]),this.editMode){case Constant.EditMode.APPLY:if(Utils.isEmpty(n))return!1;for(var r=this.map.tileset.imagewidth/this.grid.cellW,a=n.x1+n.y1*r,s=0;s<=n.y2-n.y1;s++)for(var l=0;l<=n.x2-n.x1;l++)if(t+l<this.map.width){var c=l+s*r,u=l+s*this.map.width;this.map.layers[this.activeLayer].data[o+u]!==a+c&&(i=!0,this.map.layers[this.activeLayer].data[o+u]=a+c)}break;case Constant.EditMode.ERASE:Utils.isEmpty(n)&&(n={x1:0,x2:0,y1:0,y2:0});for(var h=0;h<=n.y2-n.y1;h++)for(var d=0;d<=n.x2-n.x1;d++)if(t+d<this.map.width){var p=d+h*this.map.width;null!==this.map.layers[this.activeLayer].data[o+p]&&(i=!0,this.map.layers[this.activeLayer].data[o+p]=null)}}return i}},{key:"getSelectionArea",value:function(){return Utils.isEmpty(this.tilePicker)?null:this.tilePicker.getSelectionArea()}},{key:"renderLayer",value:function(t,i,n,o,r,a,s){t>this.activeLayer&&(n.globalAlpha=e.UPPER_LEVEL_OPACITY),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"renderLayer",this).call(this,t,i,n,o,r,a,s)}},{key:"renderInterLayerElements",value:function(t,e,i,n,o){t===Constant.MapLayer.MID&&MapManager.renderUI(this.map,this.grid,this.context,this.renderingConfiguration,e,i,n,o)}},{key:"renderTopLayerElements",value:function(t,e,i,n){}},{key:"resizeMap",value:function(t,e){MapManager.resizeMap(this.map,t,e)}},{key:"setTilePicker",value:function(t){this.tilePicker=t}},{key:"setActiveLayer",value:function(t){this.activeLayer=t}},{key:"setEditMode",value:function(t){this.editMode=t}},{key:"getMap",value:function(){return this.map}}]),e}(AbstractStaticScene);MapperScene.UPPER_LEVEL_OPACITY=.5;var TilePicker;!function(t){function e(t,e){a=null,new StaticGrid(t,function(i){new TilePickerScene(i,t.height,t.width,function(o){a=o,n(t,i),a.start(t),a.toggleEditorGrid(!0),e(a)})},GridTypeEnum.tilePicker)}function i(e,i){var n=$("#canvasTile")[0],o=n.getContext("2d"),r=$("#canvasSelector")[0];o.clearRect(0,0,n.width,n.height),Resource.load(e,3,function(e){var a=new Image;a.src=e.attr("src"),$("#tilePanel").height(a.naturalHeight),n.height=a.naturalHeight,n.width=a.naturalWidth,r.height=a.naturalHeight,r.width=a.naturalWidth,o.drawImage(e[0],0,0),t.start(r,i)})}function n(t,e){var i=new Map;Input.init(t,e,i,function(){},function(){},function(t,e,i){(Utils.isEmpty(i)||i===Input.MouseButtons.LEFT)&&a.select(t,e)},function(t,e,i){(Utils.isEmpty(i)||i===Input.MouseButtons.LEFT)&&a.selectEnd(t,e)},function(t,e,i){(Utils.isEmpty(i)||i===Input.MouseButtons.LEFT)&&a.selectEnd(t,e),a.updatePointer(t,e)},function(t,e){a.updatePointer(t,e)},function(){},function(){},function(){},function(t,e){a.cleanSelection()},function(){console.log("doubleClick")},function(){console.log("wheel")})}function o(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=$("#mapPanel").jstree(!0).get_json("#");$.ajax({url:"edit/maps",type:"post",contentType:"application/json",data:JSON.stringify(e),success:function(e){console.log("Maps updated"),null!==t&&t(!0)}})}function r(t){a.setMapper(t)}var a;t.start=e,t.loadTile=i,t.saveData=o,t.setMapper=r}(TilePicker||(TilePicker={}));var TilePickerScene=function(t){function e(t,i,n,o){_classCallCheck(this,e);var r=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i,n));return o(r),r}return _inherits(e,t),_createClass(e,[{key:"setMapper",value:function(t){this.mapper=t}},{key:"select",value:function(t,i){Utils.isEmpty(this.mapper)||this.mapper.cleanSelection(),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"select",this).call(this,t,i)}}]),e}(AbstractTileScene),StaticGrid=function(t){function e(t,i,n,o){_classCallCheck(this,e);var r=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i,n));return r.overriddenProps=o,r}return _inherits(e,t),_createClass(e,[{key:"deferredInit",value:function(t){switch(Utils.isEmpty(this.overriddenProps)||(t=Utils.mergeMaps(this.overriddenProps,t)),_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"deferredInit",this).call(this,t),this.tileColumns=t.get("tileColumns"),this.gridType){case GridTypeEnum.mapper:this.canvasScales=[],this.canvasScales.push(t.get("canvasScaleD")),this.canvasScales.push(t.get("canvasScaleC")),this.canvasScales.push(t.get("canvasScaleB")),this.canvasScales.push(t.get("canvasScaleA"));var i=this.canvasScales.length;this.rowsList=Array(i),this.columnsList=Array(i);for(var n=i-1,o=0;o<i;o++)this.rowsList[o]=Math.floor(this.rows/this.canvasScales[o]),this.columnsList[o]=Math.floor(this.columns/this.canvasScales[o]);this.selectScale(n);break;case GridTypeEnum.tilePicker:this.scaleX=1,this.scaleY=1,this.updateSize(this.canvas.width,this.canvas.height)}}},{key:"selectScale",value:function(t){this.rows=this.rowsList[t],this.columns=this.columnsList[t],this.updateSizingDerivates(),this.scaleX=this.canvasScales[t],this.scaleY=this.canvasScales[t]}},{key:"updateSize",value:function(t,e){this.rows=Math.floor(e/this.cellH),this.columns=Math.floor(t/this.cellW),this.updateSizingDerivates()}},{key:"getBoundariesX",value:function(t,i){return _get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"getBoundariesX",this).call(this,t,i)}},{key:"getBoundariesY",value:function(t,i){return _get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"getBoundariesY",this).call(this,t,i)}},{key:"refresh",value:function(){_get(e.prototype.__proto__||Object.getPrototypeOf(e.prototype),"refresh",this).call(this)}}]),e}(AbstractGrid),Tilesetter;!function(t){function e(t,e){r=null,new StaticGrid(t,function(i){var o=$("#editModes")[0],a=Constant.TileEditMode[o.value];new TilesetterScene(i,t.height,t.width,a,function(o){r=o,n(t,i),r.start(t),r.toggleEditorGrid(!0),e(r)})},GridTypeEnum.tilePicker)}function i(e,i){var n=$("#canvasTile")[0],o=n.getContext("2d"),r=$("#canvasSelector")[0];o.clearRect(0,0,n.width,n.height),Resource.load(e,3,function(e){var a=new Image;a.src=e.attr("src"),$("#tilePanel").height(a.naturalHeight),n.height=a.naturalHeight,n.width=a.naturalWidth,r.height=a.naturalHeight,r.width=a.naturalWidth,o.drawImage(e[0],0,0),t.start(r,i)})}function n(t,e){var i=new Map;Input.init(t,e,i,function(){},function(){},function(t,e,i){(Utils.isEmpty(i)||i===Input.MouseButtons.LEFT)&&r.select(t,e)},function(t,e,i){(Utils.isEmpty(i)||i===Input.MouseButtons.LEFT)&&r.selectEnd(t,e)},function(t,e,i){(Utils.isEmpty(i)||i===Input.MouseButtons.LEFT)&&r.selectEnd(t,e),r.updatePointer(t,e)},function(t,e){r.updatePointer(t,e)},function(){},function(){},function(){},function(t,e){r.cleanSelection()},function(){console.log("doubleClick")},function(){console.log("wheel")})}function o(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,e=$("#mapPanel").jstree(!0).get_json("#");$.ajax({url:"edit/maps",type:"post",contentType:"application/json",data:JSON.stringify(e),success:function(e){console.log("Maps updated"),null!==t&&t(!0)}})}var r;t.start=e,t.loadTile=i,t.saveData=o}(Tilesetter||(Tilesetter={}));var TilesetterPage;!function(t){function e(){Compatibility.check();var t=function(t){var e=+t.get("cellWidth")*+t.get("tileColumns")+2;$("#toolsPanel").width(e)};Resource.loadProperties(t),i(),n()}function i(){$.getJSON(base_path+"data/resources/tiles.json",function(t){for(var e=$("#tiles"),i=0;i<t.length;i++)e.append("<option value='"+t[i].name+"'>"+t[i].desc+"</option>");o()})}function n(){$.getJSON(base_path+"news",function(t){$("#news")})}function o(){var t=$("#tiles").val();Tilesetter.loadTile(t,function(t){t.toggleBlocks(!0)}),l(!0)}function r(){$("#editModes").val()}function a(){}function s(){}function l(e){!(arguments.length>1&&void 0!==arguments[1])||arguments[1];c=e,document.title=e?t.PAGE_TITLE+"*":t.PAGE_TITLE,$("#saveButton")[0].disabled=!e,$("#reloadButton")[0].disabled=!e}t.PAGE_TITLE=document.title,t.BUTTON_ID_MODE="mode",t.BUTTON_ID_LAYER="layer";var c=!1;t.start=e,t.loadNews=n,t.changeTile=o,t.changeTileEditMode=r,t.save=a,t.reload=s,t.changeEditState=l}(TilesetterPage||(TilesetterPage={}));var TilesetterScene=function(t){function e(t,i,n,o,r){_classCallCheck(this,e);var a=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t,i,n));return r(a),a.changeTileEditMode(o),a.map.width=a.getSceneWidth(),a.map.height=a.getSceneHeight(),a.map.blocks=[],a}return _inherits(e,t),_createClass(e,[{key:"changeTileEditMode",value:function(t){switch(this.toggleBlocks(!1),t){case Constant.TileEditMode.NONE:break;case Constant.TileEditMode.BLOCKS:this.toggleBlocks(!0)}}}]),e}(AbstractTileScene);